---
title: "Datos Clínicos"
author: "Nuria"
date: "2023-03-08"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE}
#Cargamos las librerías que vamos a utilizar
library(openxlsx)
library(ggplot2)
library(gridExtra)
library(survival)
library(dplyr)
library(survminer)
```

## Datos Clínicos pacientes Luis Miguel

Se va a realizar un análisis explorativo (AED) sobre los datos clínicos de los pacientes a estudio  con la finalidad de conocer la calidad de los datos y predecir algunas respuestas a nuestras preguntas. 

```{r importar datos, warning=FALSE}
# Leemos el excel y lo guardamos como un dataframe
dfClinical <- openxlsx::read.xlsx("./DATOS CLÍNICOS asociados a RNA-seq.xlsx", "Hoja1")

# Los datos de la matriz estan ordenados como si los números fuesen carácteres, por lo que voy a transformar la variable "Sample" del dataframe de los datos clínicos a carácter, y después lo ordenaré de menor a mayor
dfClinical$Samples <- as.character(dfClinical$Samples)
dfClinical <- dfClinical[order(dfClinical$Samples),]

# Elimino la fila del paciente 88 en los datos clinicos
dfClinical <- dfClinical[dfClinical$Samples != "88",]

# Mostramos el dataframe en Rstudio
#View(dfClinical)
```

En primer lugar, se precisa a la realización de un análisis descriptivo inicial para conocer los valores de las variables con las que se va a trabajar. Así pues, se va a analizar cada uno de las variables clinico-patológicas en función del grado, con el objetivo de conocer nuevos factores que ayuden a entender las diferencias entre ellos.

## Edad del paciente cuando se diagnostico la enfermedad en función del grado
```{r}
# Calculamos la edad de diagnóstico para cada grado
#Grado II
PacientesII <-(subset(dfClinical,dfClinical$Grade =="II")) 

#Hacemos el resumen 
sprintf("Resumen de la edad de diagnóstico para el Grado II ")
summary(PacientesII$Age.at.diagnosis)

#Grado IV
PacientesIV <-(subset(dfClinical,dfClinical$Grade =="IV")) 

#Hacemos el resumen 
sprintf("Resumen de la edad de diagnóstico para el Grado IV ")
summary(PacientesIV$Age.at.diagnosis)

#Dibujamos una gráfica que muestre la edad de diagnóstico vs el grado
ggplot(dfClinical,aes(Grade,Age.at.diagnosis))+geom_boxplot() + 
  geom_boxplot(fill = "orange", outlier.colour = "red", outlier.shape = 1) +
  theme_bw() + 
  labs(x = "Grado del glioblastoma", y ="Edad de diagnóstico")
```

## Género del paciente 

```{r}
# Mostramos la tabla de contigencia:
sprintf("Género de los pacientes")
table(dfClinical$Gender, dfClinical$Grade)

#Dibujamos una gráfica de que represente grado vs género 
ggplot(dfClinical, aes(x = Grade, fill = Gender)) + 
       geom_bar() + 
       labs(x = "Grado", y = "Frecuencia",fill = "Género") + 
       theme_bw()
```
## Localización del tumor 

```{r}
# Definimos una función que clasifica estos datos según el hemisferio cerebral
AssignCerebralHemisphere <- function(sValue) {
  if (grepl("[Ll]eft", sValue)) {
    return("Izquierda")
  } else if (grepl("[Rr]ight", sValue)) {
    return("Derecha")
  } else {
    return(NULL)
  }
}

# Creamos un factor con esta función
dfClinical$fTumorHemisphere <- as.factor(unlist(lapply(dfClinical$Tumor.localization, function(x) AssignCerebralHemisphere(x))))

# Mostramos cuantos pacientes hay por grupo
sprintf("Hemisferio cerebral")
table(dfClinical$fTumorHemisphere)

#Dibujamos una gráfica que represente el hemisferio vs grado 
ggplot(dfClinical, aes(x = Grade, fill = fTumorHemisphere)) + 
       geom_bar() + 
       labs(x = "Grado", y = "Frecuencia",fill = "Hemisferio cerebral") + 
       theme_bw()

# Hacemos lo mismo para clasificar en función del lóbulo cerebral
AssignCerebralLobule <- function(sValue) {
  if (grepl("[Oo]ccipital", sValue)) {
    return("occipital")
  } else if (grepl("[Pp]ariet", sValue)) {
    return("parietal")
  } else if (grepl("[Ff]ront", sValue)) {
    return("frontal")
  } else if (grepl("[Tt]emporal", sValue)) {
    return("temporal")
  } else {
    return(NULL)
  }
}

# Creamos un factor con esta función
dfClinical$fTumorLobule <- as.factor(unlist(lapply(dfClinical$Tumor.localization, function(x) AssignCerebralLobule(x))))

# Mostramos cuantos pacientes hay por grupo
sprintf("Lóbulo cerebral")
table(dfClinical$fTumorLobule)

# Podemos contabilizar los individuos con los dos factores conjuntamente
sprintf("Lóbulo-hemisferio cerebral")
table(dfClinical$fTumorHemisphere, dfClinical$fTumorLobule)

#Dibujamos una gráfica que represente el lóbulo vs grado 
ggplot(dfClinical, aes(x = Grade, fill = fTumorLobule)) + 
       geom_bar() + 
       labs(x = "Grado", y = "Frecuencia",fill = "Lóbulo cerebral") + 
       theme_bw()
```

## Supervivencia

  Analisis preliminar de la supervivencia 

```{r, warning=FALSE}
# Estimación de la supervivencia sin variables predictoras
fit <- survfit(Surv(Survival,Status)~ 1, data = dfClinical)

#Hacemos un resumen de estos datos 
summary(fit)
```

``` {r, warning=FALSE}
#Dibujamos la cuerva de supervivencia 
ggsurvplot(fit, data = dfClinical, 
           palette = "blue", 
           conf.int = FALSE, 
           surv.median.line = "hv")
```

Relacionamos la supervivencia con la edad, el género y la localización del tumor 

##Supervivencia vs Edad 

```{r, warning=FALSE}
#Como la edad de diagnóstico es una variable numérica, se calcula la edad media para poder representar esta predictora frente a la supervivenca
corte <-surv_cutpoint(dfClinical,time="Survival",event="Status",variables="Age.at.diagnosis")

#Vemos el resutado obtenido 
corte
```
```{r}
#Estimación de la curva de supervivencia en base al factor de la edad de diagnóstico
dfClinical$RAge <- ifelse(dfClinical$Age.at.diagnosis>=62,"+62","-62")
fit <- survfit(Surv(Survival,Status)~ RAge, data = dfClinical)

#Dibujamos la curva de supervivencia
ggsurvplot(fit, data = dfClinical, 
           conf.int = TRUE, 
           conf.int.style = "step", 
           surv.median.line = "hv", 
           pval = TRUE)
```


## Supervivencia vs Género  

```{r, warning=FALSE}
#Estimación de la curva de supervivencia en base al factor del género
fit <- survfit(Surv(Survival,Status)~ Gender, data = dfClinical)

#Dibujamos la curva de supervivencia
ggsurvplot(fit, data = dfClinical, 
           conf.int = TRUE, 
           conf.int.style = "step", 
           surv.median.line = "hv", 
           pval = TRUE)
```

## Supervivencia vs Localización del tumor 

``` {r,warning=FALSE}
#Estimación de la curva de supervivencia en base a la localización del tumor
fit <- survfit(Surv(Survival,Status)~ Tumor.localization, data = dfClinical)

#Dibujamos la curva de supervivencia
ggsurvplot(fit, data = dfClinical, 
           conf.int = TRUE, 
           conf.int.style = "step", 
           surv.median.line = "hv", 
           pval = TRUE)

```

Como tenemos una cohorte muy escasa y es preferible separar esta variable en dos. Así pues, calculamos la curva de supervivencia para el hemisferio y para el lóbulo. 

```{r,warning=FALSE}
#Estimación de la curva de supervivencia en base al hemisferio 
fit <- survfit(Surv(Survival,Status)~ fTumorHemisphere, data = dfClinical)
fit

#Dibujamos la curva de supervivencia
ggsurvplot(fit, data = dfClinical, 
           conf.int = TRUE, 
           conf.int.style = "step", 
           surv.median.line = "hv", 
           pval = TRUE)
```
```{r,warning=FALSE}
#Estimación de la curva de supervivencia en base al lóbulo
fit <- survfit(Surv(Survival,Status)~ fTumorLobule, data = dfClinical)

#Dibujamos la curva de supervivencia
ggsurvplot(fit, data = dfClinical, 
           conf.int = TRUE, 
           conf.int.style = "step", 
           surv.median.line = "hv", 
           pval = TRUE)
```


